<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="web3-whisperclient">

<template>
  <style include="shared-styles">
    :host {
      display: block;
    }

    span,
    input {
      @apply(--paper-font-body2);
    }
    paper-toolbar {
      background-color: grey;
    }

    .chatcontainer {
      @apply(--layout-vertical);
      background-color: #333333;
      color: white;
    }

    .messages {
      @apply(--layout-flex);
      padding: 10px;
      background-color: #333;
      overflow-y: scroll;
    }

    .messageinput {
      @apply(--layout-horizontal);
      @apply(--layout-end);
      background-color: grey;
      height: 70px;
      width: 100%;
    }

    .paperinput {
      @apply(--layout-flex);
      color: white;
      background-color: #777;
      border-radius: 10px;
      padding-left: 10px;
      padding-right: 10px;
      margin: 10px;
    }

    .sendbutton {
      margin-right: 10px;
    }

    #paperinput {
      margin-top: -15px;
    }

    .nick {
      font-weight: bolder;
      color: #aaa;
    }
    .drawerstuff {
      background-color: black;
    }

    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
    }
  </style>
  <style include="iron-flex iron-flex-alignment"></style> 

  <paper-drawer-panel force-narrow>
    <paper-header-panel drawer>
    <div class="drawerstuff">
    <x-notification autoshow title="{{notificationbody.nick}}" delay="1000" icon="https://avatars3.githubusercontent.com/u/2879379?v=3&s=460" timeout="6000" tag="tag"><span>{{notificationbody.input}}</span></x-notification>
      <paper-toolbar>Menu</paper-toolbar>
      <iron-localstorage 
      id="nickstorage" 
      name="nick"
      value="{{nickname}}" 
      ></iron-localstorage>
      <paper-input value="{{nickname}}" label="your nickname"></paper-input>
      <paper-button on-click="_changenick" raised>change nickname</paper-button>
      <paper-input value="{{topic}}" label="the topic"></paper-input>
    </div>
    </paper-header-panel>

    <div main class="chatcontainer">

      <paper-toolbar>
      <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
      <div>{{topic}}</div>
      </paper-toolbar>

      <div class="messages" id="msgbox">
     
        <template is="dom-repeat" items="{{chatbox}}">
          <div>
            <span>
              <img class="avatar" src="//gateway.ipfs.io/ipfs/{{avatar}}" />
            </span> <span class="nick">{{item.nick}}</span>
          <span>{{item.input}}
            </span>
          </div>
        </template>
      </div>

    <div class="messageinput">
        <div class="paperinput">
          <paper-input autofocus id="paperinput" value="{{chatinput}}" label="Type a message" on-keydown="checkForEnter"></paper-input>
        </div>
        <paper-icon-button icon="attachment" class="sendbutton"></paper-icon-button>
    </div>

  </div>
    
  </paper-drawer-panel>
</template>



  <script>
    (function() {
      'use strict';

      var activewindow;

      function onBlur() {
  document.body.className = 'blurred';
  activewindow = false;
};
function onFocus(){
  document.body.className = 'focused';
  activewindow = true;
};

if (/*@cc_on!@*/false) { // check for Internet Explorer
  document.onfocusin = onFocus;
  document.onfocusout = onBlur;
} else {
  window.onfocus = onFocus;
  window.onblur = onBlur;
};

      Polymer({
        is: 'web3-whisperclient',


        properties: {
          web3: {
            type: Object,
            observer: '_web3'
          },
          chatinput: {
            type: String,
            //observer: '_chatinput'
          },
          chatbox: {
            type: Array,
            value: [],
            notify: true
          },
          nickname: {
            type: String,
            value: "Anonymous Coward " + Math.floor(100 + Math.random() * 999)
          },
          topic: {
            type: String,
            value: "De A-labs fluisteraars"
          },
          avatar: {
            type: String,
            value: "QmNSXYrGmGtTd6FwsjyoicLVh4mzZCnnYSCb7GvQLw22Ec"
          }
        },

        ready: function(){
        },

        _web3: function() {

          var self = this;
          console.log('web3 started');


          this.identity = this.web3.shh.newIdentity();

          var filter = this.web3.shh.filter({
            "topics": [this.web3.fromAscii(this.topic)],
          });

          filter.watch(function(error, result) {
            if (!error)
              self.push('chatbox', JSON.parse(self.web3.toAscii(result.payload)));
              self.scrollTop();
              self.notificationbody = JSON.parse(self.web3.toAscii(result.payload));
              if(activewindow){
                document.querySelector('x-notification').show();
              }
          });

          this.whisperpost('chatbot', this.nickname + ' has joined the room');



        },
        attached: function() {
          this.oldnick = this.nickname;
          setInterval(this.scrollTop, 500);
        },

        scrollTop: function(){
          var elem = document.getElementById('msgbox');
          elem.scrollTop = elem.scrollHeight;
          console.log("Scrolling to top");
        },

        _changenick: function() {
          if (this.oldnick) {
            this.whisperpost('chatbot', this.oldnick + ' is now known as ' + this.nickname);
          }
          this.oldnick = this.nickname;
        },

        _sendmessage: function() {

          if(this.chatinput != ''){

          var postresult = this.whisperpost(this.nickname, this.chatinput, this.avatar);

          if (postresult) {
            this.chatinput = '';
          }

        }

        },

        checkForEnter: function (e) {
            // check if 'enter' was pressed
            if (e.keyCode === 13) {
                // enter pressed!
                this._sendmessage();
            }
        },

        whisperpost: function(nick, input, avatar) {
          return this.web3.shh.post({
            "from": this.identity,
            "topics": [this.web3.fromAscii(this.topic)],
            "payload": this.web3.fromAscii(JSON.stringify({
              nick: nick,
              avatar: avatar,
              input: input
            })),
            "ttl": 100,
            "priority": 1000
          });
        }
      });
    })();
  </script>
</dom-module>